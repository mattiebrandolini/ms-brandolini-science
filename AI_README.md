# AI Maintenance Guide

> **For Claude (or any AI assistant) working on this codebase.**
> Read this first when starting a session. It tells you what exists, where things live, and how to do common tasks without breaking anything.

## Quick Reference

| What | Where |
|------|-------|
| Build command | `cd build && python3 build.py` |
| Config (courses, URLs, versions) | `build/config.py` |
| Templates (all page HTML) | `build/templates/*.html` |
| CSS variables reference | `styles/REFERENCE.md` |
| Generated pages | `student/`, `teacher/`, `index.html`, `404.html` |
| Course viewer logic | `js/course-viewer.js` |
| Per-course configs | `js/config-biology.js`, `js/config-envbio.js`, `js/config-chemistry.js` |
| Theme + accessibility panel | `js/toolbar.js` |
| Self-hosted fonts | `static/fonts/` |
| CSV snapshots (build-time) | `static/data/` |
| CI workflow | `.github/workflows/quality.yml` |

## Critical Rules

1. **Never edit generated HTML directly.** Files in `student/`, `teacher/`, and root `index.html`/`404.html` are generated by `build.py`. Edit templates and config, then rebuild.
2. **No external CDN dependencies.** All fonts are self-hosted. All JS is local. If you add a library, download it and put it in the repo.
3. **Bump `CACHE_VERSION` in `config.py`** after changing any CSS or JS file, then rebuild.
4. **Test the build** before committing: `cd build && python3 build.py`

## Common Tasks

### Add a new course

1. Add course dict to `COURSES` list in `build/config.py`:
   ```python
   {
       "slug": "anatomy-physiology",
       "title": "Anatomy & Physiology",
       "icon": "ðŸ«€",
       "color_class": "anat",
       "status": "live",  # change from "wip" to "live"
       "topic_count": 45,
       "student_desc": "...",
       "teacher_desc": "...",
       "og_desc": "...",
       "config_js": "config-anatomy.js",  # only if it has a resource viewer
       "sheet_url": "https://docs.google.com/spreadsheets/d/e/.../pub?output=csv",
   }
   ```
2. If it has a resource viewer, create `js/config-anatomy.js` following the pattern in existing config files. Include `slug`, `title`, `sheetUrl`, `tabs`, and `topics`.
3. Run `cd build && python3 build.py`
4. Bump `CACHE_VERSION` if you changed JS.
5. Commit and push.

### Change site-wide colors

1. Read `styles/REFERENCE.md` to find the variable name.
2. Edit the variable in the `:root` block of `styles/main.css`.
3. If it affects the course viewer, also check `styles/course-viewer.css`.
4. Bump `CACHE_VERSION` in `build/config.py`.
5. Rebuild: `cd build && python3 build.py`

### Add an accessibility toggle

1. In `js/toolbar.js`:
   - Add the `data-*` attribute to the early-apply section at the top.
   - Add a toggle row in the panel HTML.
   - The toggle handler is generic â€” it just sets/removes the attribute.
2. In `styles/main.css` and `styles/course-viewer.css`:
   - Add CSS rules targeting `[data-yourattr="true"]`.
3. Bump `CACHE_VERSION`, rebuild.

### Add a new resource type to the viewer

1. In the Google Sheet, add resources with the new type value.
2. In `js/course-viewer.js`, the type rendering is automatic â€” types are extracted from the CSV `type` column. No code change needed unless you want a custom icon or special rendering.
3. Rebuild to refresh the CSV snapshot.

### Update CSV snapshots (refresh offline data)

Run `cd build && python3 build.py` â€” it fetches fresh CSVs automatically.

### Change the topbar or footer

1. Edit `build/templates/base.html` (shared across all pages).
2. For page-specific changes, edit the relevant template in `build/templates/`.
3. Rebuild.

### Add a glossary term (in any HTML or template)

Use the `<dfn>` element with a `data-def` attribute:
```html
<dfn data-def="The process plants use to make food from sunlight" tabindex="0">Photosynthesis</dfn>
```
The definition appears on hover or keyboard focus. Works on any page that loads `main.css`.

### Debug "it works locally but not on the site"

1. Check if GitHub Pages is caching old files â†’ bump `CACHE_VERSION` and rebuild.
2. Check if a school network is blocking something â†’ all fonts/JS should be self-hosted; if a Google Sheets CSV is blocked, the snapshot fallback should kick in.
3. Check CI results at the repo's Actions tab.

## Architecture Overview

```
User visits page
  â†’ Static HTML (generated by build.py from Jinja2 templates)
  â†’ CSS loads (self-hosted fonts via static/fonts/fonts.css)
  â†’ toolbar.js injects theme toggle + accessibility panel into topbar
  â†’ On resource pages: config-{course}.js sets COURSE_CONFIG
  â†’ course-viewer.js reads config, fetches CSV (live â†’ snapshot fallback)
  â†’ Renders topic list with filters, search, QR codes
```

## Template Inheritance

```
base.html (head, meta, fonts, scripts, skip-link, <main>)
  â”œâ”€â”€ splitter.html (front door)
  â”œâ”€â”€ student_home.html (course cards)
  â”œâ”€â”€ teacher_home.html (teacher cards)
  â”œâ”€â”€ course_stub.html (per-course landing, student or teacher)
  â”œâ”€â”€ course_resources.html (resource viewer shell)
  â”œâ”€â”€ tools_hub.html (interactive tools)
  â””â”€â”€ 404.html
```

## DOM Hooks (do not remove)

These IDs and classes are referenced by JavaScript:

| Selector | Used by | Purpose |
|----------|---------|---------|
| `#cv-root` | course-viewer.js | Resource viewer mount point |
| `.topbar-nav` | toolbar.js | Injects theme/a11y buttons here |
| `.topbar` | toolbar.js | Fallback injection point |
| `#tb-theme` | toolbar.js | Theme toggle button |
| `#tb-a11y` | toolbar.js | Accessibility panel button |
| `#tb-panel` | toolbar.js | Accessibility panel container |
| `[data-theme]` | toolbar.js + CSS | Theme switching |
| `[data-dyslexic]` | toolbar.js + CSS | Dyslexia font toggle |
| `[data-colorblind]` | toolbar.js + CSS | Colorblind mode |
| `[data-spacing]` | toolbar.js + CSS | Extra spacing |
| `[data-motion]` | toolbar.js + CSS | Reduced motion |
| `[data-textsize]` | toolbar.js + CSS | Text size |

## CSV Schema

Each Google Sheet must have these columns (order doesn't matter, names are case-sensitive):

| Column | Required | Description |
|--------|----------|-------------|
| `topic` | Yes | Topic code (e.g., "1A", "2B") |
| `type` | Yes | Resource type (e.g., "Video", "Simulation", "Reading") |
| `title` | Yes | Display title |
| `url` | Yes | Resource URL |
| `provider` | No | Source name (e.g., "Amoeba Sisters", "PhET") |
| `video_id` | No | YouTube video ID (for thumbnail generation) |
| `notes` | No | Teacher/student notes |
| `captions` | No | "yes" if resource has captions/subtitles (enables CC filter + badge) |
